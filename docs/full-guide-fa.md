# راهنمای جامع راه‌اندازی ربات فروش حساب

این راهنما برای کاربرانی نوشته شده که پیش از این با Cloudflare Workers، Wrangler CLI یا پایگاه داده D1 آشنایی نداشته‌اند. در این آموزش تمام مراحل لازم برای راه‌اندازی پروژه از صفر توضیح داده می‌شود.

## فهرست مطالب
1. [معرفی سرویس‌ها](#معرفی-سرویس‌ها)
2. [پیش‌نیازهای نرم‌افزاری](#پیش‌نیازهای-نرم‌افزاری)
3. [ساخت حساب Cloudflare](#ساخت-حساب-cloudflare)
4. [نصب Wrangler CLI](#نصب-wrangler-cli)
5. [ساخت پروژه و تنظیمات اولیه](#ساخت-پروژه-و-تنظیمات-اولیه)
6. [ایجاد پایگاه داده D1](#ایجاد-پایگاه-داده-d1)
7. [تنظیم متغیرهای محرمانه](#تنظیم-متغیرهای-محرمانه)
8. [اجرای محلی و تست](#اجرای-محلی-و-تست)
9. [انتشار Worker](#انتشار-worker)
10. [تنظیم وب‌هوک تلگرام](#تنظیم-وب-هوک-تلگرام)
11. [گام‌های بعدی](#گام‌های-بعدی)

---

## معرفی سرویس‌ها

قبل از شروع بهتر است با سرویس‌های اصلی مورد استفاده در این پروژه آشنا شویم:

- **Cloudflare Workers**: سرویسی برای اجرای کد JavaScript یا TypeScript روی لبه‌های شبکهٔ Cloudflare. با این سرویس می‌توانید بدون نیاز به سرور جداگانه، درخواست‌ها را پردازش کنید.
- **Wrangler CLI**: ابزار خط فرمان رسمی Cloudflare برای مدیریت و استقرار Workers. با Wrangler می‌توانیم پروژه ایجاد کنیم، تست بگیریم و در نهایت Worker را منتشر کنیم.
- **Cloudflare D1**: پایگاه داده‌ی رابطه‌ای مبتنی بر SQLite که روی زیرساخت Cloudflare اجرا می‌شود. برای ذخیره‌سازی داده‌های ربات از D1 استفاده می‌کنیم.

## پیش‌نیازهای نرم‌افزاری

برای اجرای دستورات این آموزش، باید ابزارهای زیر را نصب کنید:

1. **Node.js** نسخهٔ 20 یا بالاتر. می‌توانید آن را از [nodejs.org](https://nodejs.org/) دریافت کنید.
2. **npm** که همراه Node.js نصب می‌شود.
3. **Git** برای کلون کردن مخزن پروژه.
4. یک **ترمینال** یا محیط خط فرمان روی سیستم عامل خود (PowerShell در ویندوز، ترمینال در macOS یا لینوکس).

## ساخت حساب Cloudflare

اگر هنوز در Cloudflare حساب ندارید، مراحل زیر را انجام دهید:

1. به آدرس [https://dash.cloudflare.com/sign-up](https://dash.cloudflare.com/sign-up) بروید.
2. یک ایمیل معتبر و گذرواژه انتخاب کرده و مراحل ثبت‌نام را تکمیل کنید.
3. پس از ورود به پیشخوان Cloudflare، می‌توانید از منوی سمت چپ به بخش **Workers & Pages** دسترسی پیدا کنید.

## نصب Wrangler CLI

Wrangler برای مدیریت پروژه‌های Workers استفاده می‌شود. دستور زیر را در ترمینال اجرا کنید:

```bash
npm install -g wrangler
```

سپس برای اتصال Wrangler به حساب Cloudflare خود از دستور زیر استفاده کنید:

```bash
wrangler login
```

در مرورگر، اجازهٔ دسترسی را تایید کنید تا Wrangler به حسابتان متصل شود.

## ساخت پروژه و تنظیمات اولیه

مخزن پروژه را کلون کنید و وارد پوشهٔ آن شوید:

```bash
git clone <URL-REPO>
cd Acc-Seller-Bot-Claude-Flare/worker/my-worker
```

فایل `wrangler.toml` شامل تنظیمات پروژه است. مقادیر `account_id` و `database_id` را با شناسه‌های مربوط به حساب Cloudflare خود جایگزین کنید.

## ایجاد پایگاه داده D1

برای ذخیرهٔ داده‌های ربات به یک پایگاه داده نیاز داریم. دستور زیر یک پایگاه دادهٔ جدید ایجاد می‌کند:

```bash
wrangler d1 create account-bot
```

پس از ایجاد، شناسهٔ پایگاه داده را یادداشت کرده و در `wrangler.toml` قرار دهید. سپس مهاجرت‌های اولیه را اعمال کنید:

```bash
wrangler d1 migrations apply account-bot
```


## تنظیم متغیرهای محرمانه

برخی اطلاعات نباید در مخزن کد قرار بگیرند. Wrangler امکان ذخیرهٔ محرمانه‌ها را فراهم می‌کند. دستورات زیر را اجرا کنید و به جای مقادیر نمونه، اطلاعات واقعی خود را وارد کنید:

```bash
wrangler secret put BOT_TOKEN
wrangler secret put ADMIN_ID
wrangler secret put ADMIN_PHONE
wrangler secret put AES_KEY
```

این مقادیر در هنگام استقرار به Worker تزریق می‌شوند.

## اجرای محلی و تست

برای مشاهدهٔ خروجی Worker به صورت محلی، از دستور زیر استفاده کنید:

```bash
wrangler dev
```

در این حالت یک آدرس محلی (معمولاً `http://localhost:8787`) در ترمینال نمایش داده می‌شود. می‌توانید با ابزارهایی مثل `curl` یا مستقیماً از مرورگر، درخواست‌های آزمایشی ارسال کنید. در صورت نیاز به دسترسی به سرویس D1 در محیط توسعه، از گزینهٔ `--remote` استفاده نمایید:

```bash
wrangler dev --remote
```

اجرای تست‌های واحد پروژه نیز به صورت زیر است:

```bash
npx vitest run
```

## انتشار Worker

پس از اطمینان از عملکرد برنامه، می‌توانید آن را روی Cloudflare منتشر کنید. کافی است دستور زیر را اجرا نمایید:

```bash
wrangler deploy
```

Wrangler فایل‌های پروژه را بسته‌بندی کرده و در حساب Cloudflare شما مستقر می‌کند. پس از پایان فرایند، یک آدرس اینترنتی برای Worker نمایش داده می‌شود.

## تنظیم وب هوک تلگرام

برای اینکه تلگرام پیام‌های شما را به Worker ارسال کند، باید یک وب‌هوک ثبت کنید. دستور زیر را اجرا کرده و `<YOUR_TOKEN>` را با توکن ربات، و `<YOUR_WORKER_DOMAIN>` را با دامنهٔ Worker جایگزین کنید:

```bash
curl "https://api.telegram.org/bot<YOUR_TOKEN>/setWebhook?url=https://<YOUR_WORKER_DOMAIN>/telegram"
```

از این پس هر پیامی که به ربات ارسال شود به آدرس مشخص‌شده هدایت می‌شود.

## گام‌های بعدی

- برای اضافه کردن امکانات جدید می‌توانید کدهای TypeScript در مسیر `src/` را ویرایش کنید.
- دستور `wrangler d1 execute account-bot --local` امکان اجرای کوئری‌های آزمایشی روی پایگاه داده را فراهم می‌کند.
- با مطالعهٔ مستندات رسمی Cloudflare می‌توانید با قابلیت‌های پیشرفتهٔ Workers و D1 بیشتر آشنا شوید.

این فایل تنها یک نقطهٔ شروع برای کار با پروژه است. پیشنهاد می‌شود برای درک عمیق‌تر، مستندات کامل‌تر در وب‌سایت Cloudflare را نیز مطالعه کنید.
