# اطلاعات پیشرفته

این فایل شامل توضیحات کامل‌تری درباره ساختار پروژه، دستورات Wrangler و قابلیت‌های ربات است.

## فهرست مطالب
- [ویژگی‌های ربات](#ویژگی‌های-ربات)
- [پشتیبانی از چند زبان](#پشتیبانی-از-چند-زبان)
- [کار با منوها](#کار-با-منوها)
- [استقرار Worker](#استقرار-worker)
- [دستورات Wrangler](#دستورات-wrangler)
- [توسعه و تست](#توسعه-و-تست)

## ویژگی‌های ربات
- افزودن محصولات همراه با قیمت، اطلاعات ورود و کد TOTP
- تایید دستی پرداخت توسط مدیر
- ارسال مجدد اطلاعات ورود در صورت نیاز
- امکان دریافت کد احراز هویت دو مرحله‌ای با دستور `/code <id>`
- مشاهده لیست خریداران و مدیریت آن‌ها توسط مدیر
- دسترسی به آمار فروش هر محصول با `/stats`
- پشتیبانی کامل از زبان انگلیسی و فارسی
- منوهای تو در تو با دکمه‌های «بازگشت» و مدیریت

## پشتیبانی از چند زبان
کاربران می‌توانند زبان دلخواه خود را با دستور زیر تغییر دهند:

```bash
/setlang <code>
```

مثال:

```bash
/setlang fa
```

## کار با منوها
پس از ارسال دستور `/start`، منوی اصلی نمایش داده می‌شود. کاربران و مدیر می‌توانند با استفاده از دکمه‌ها بین بخش‌های مختلف جابه‌جا شوند و با انتخاب «بازگشت» به مرحله قبل برگردند.

## استقرار Worker
این پروژه شامل یک Cloudflare Worker در مسیر `worker/my-worker` است. قبل از استقرار موارد زیر را انجام دهید:

1. نصب Wrangler و ورود به حساب:
   ```bash
   npm install -g wrangler
   wrangler login
   ```
2. ویرایش فایل `wrangler.toml` و جایگزین کردن شناسه‌ها با مقادیر حساب Cloudflare خود. خط `route` نمونه را با مسیر واقعی Worker جایگزین کنید یا در صورت نیاز آن را حذف کنید (مثال: `route = "https://example.com/*"`).
3. ایجاد پایگاه داده D1:
   ```bash
   wrangler d1 create account-bot
   wrangler d1 migrations apply account-bot
   ```
4. قرار دادن مقادیر محرمانه با دستور `wrangler secret put`.
5. اجرای `wrangler deploy` برای انتشار Worker.

### متغیرهای محیطی
در حین استقرار، متغیرهای زیر باید تعیین شوند:

| نام متغیر | توضیح |
|-----------|-------|
| `BOT_TOKEN` | توکن ربات تلگرام |
| `ADMIN_ID` | شناسه تلگرام مدیر |
| `ADMIN_PHONE` | شماره تماس برای نمایش به کاربران |
| `AES_KEY` | کلید AES برای رمزگذاری اطلاعات |
| `DB` | اتصال پایگاه داده D1 |
| `TOTP_KEY` | کلید اشتراکی برای دسترسی به مسیر `/totp` (اختیاری) |

### مسیر `/totp`
در صورت تعیین `TOTP_KEY` می‌توانید با درخواست زیر کد TOTP دریافت کنید:

```bash
https://<worker-domain>/totp?secret=YOUR_SECRET&key=YOUR_SHARED_KEY
```

## دستورات Wrangler
- `wrangler dev` اجرای محیط توسعه محلی
- `wrangler dev --remote` پیش‌نمایش از طریق لبه‌های Cloudflare
- `wrangler d1 execute` اجرای دستورات SQL
- `wrangler d1 migrations apply` اعمال مهاجرت‌ها

## توسعه و تست
برای اجرای تست‌ها نیاز به Node.js 20 و پایگاه داده D1 محلی دارید:

```bash
wrangler d1 migrations apply
npx vitest run
```

فایل‌های مهاجرت در پوشه `worker/my-worker/migrations/` قرار دارند.

## راهنمای گام‌به‌گام
اگر در استفاده از Cloudflare تجربه ندارید و ترجیح می‌دهید تمامی مراحل نصب و راه‌اندازی را با جزئیات کامل مطالعه کنید، به سند [full-guide-fa.md](full-guide-fa.md) در همین پوشه مراجعه کنید.
